---
description: 利用可能な設計成果物に基づいて、実行可能な依存関係順のtasks.mdを生成します。
handoffs:
  - label: Analyze For Consistency
    agent: speckit.analyze
    prompt: Run a project analysis for consistency
    send: true
  - label: Implement Project
    agent: speckit.implement
    prompt: Start the implementation in phases
    send: true
---

## ユーザー入力

```text
$ARGUMENTS
```

続行する前に、ユーザー入力を**必ず**考慮してください（空でない場合）。

## 概要

1. **セットアップ**: リポジトリルートから `.specify/scripts/bash/check-prerequisites.sh --json` を実行し、FEATURE_DIR と AVAILABLE_DOCS リストを解析します。すべてのパスは絶対パスでなければなりません。"I'm Groot" のような引数内のシングルクォートには、エスケープ構文を使用してください: 例 'I'\''m Groot'（または可能であればダブルクォート: "I'm Groot"）。

2. **設計ドキュメントを読み込む**: FEATURE_DIR から読み取り:
   - **必須**: plan.md（技術スタック、ライブラリ、構造）、spec.md（優先順位付きユーザーストーリー）
   - **オプション**: data-model.md（エンティティ）、contracts/（APIエンドポイント）、research.md（決定事項）、quickstart.md（テストシナリオ）
   - 注: すべてのプロジェクトがすべてのドキュメントを持っているわけではありません。利用可能なものに基づいてタスクを生成します。

3. **タスク生成ワークフローを実行**:
   - plan.md を読み込み、技術スタック、ライブラリ、プロジェクト構造を抽出
   - spec.md を読み込み、優先順位付きユーザーストーリー（P1、P2、P3など）を抽出
   - data-model.md が存在する場合: エンティティを抽出してユーザーストーリーにマッピング
   - contracts/ が存在する場合: エンドポイントをユーザーストーリーにマッピング
   - research.md が存在する場合: セットアップタスクの決定事項を抽出
   - ユーザーストーリーごとに整理されたタスクを生成（以下のタスク生成ルールを参照）
   - ユーザーストーリー完了順序を示す依存関係グラフを生成
   - ユーザーストーリーごとの並列実行例を作成
   - タスクの完全性を検証（各ユーザーストーリーに必要なすべてのタスクがあり、独立してテスト可能）

4. **tasks.md を生成**: `.specify.specify/templates/tasks-template.md` を構造として使用し、以下を記入:
   - plan.md からの正しい機能名
   - フェーズ1: セットアップタスク（プロジェクト初期化）
   - フェーズ2: 基礎タスク（すべてのユーザーストーリーのブロッキング前提条件）
   - フェーズ3以降: ユーザーストーリーごとに1つのフェーズ（spec.md からの優先順位順）
   - 各フェーズには以下を含む: ストーリーゴール、独立したテスト基準、テスト（要求された場合）、実装タスク
   - 最終フェーズ: 洗練と横断的関心事
   - すべてのタスクは厳格なチェックリスト形式に従う必要があります（以下のタスク生成ルールを参照）
   - 各タスクの明確なファイルパス
   - ストーリー完了順序を示す依存関係セクション
   - ストーリーごとの並列実行例
   - 実装戦略セクション（MVP優先、段階的デリバリー）

5. **レポート**: 生成された tasks.md へのパスと要約を出力:
   - 総タスク数
   - ユーザーストーリーごとのタスク数
   - 特定された並列実行の機会
   - 各ストーリーの独立したテスト基準
   - 推奨MVPスコープ（通常はユーザーストーリー1のみ）
   - 形式検証: すべてのタスクがチェックリスト形式に従うことを確認（チェックボックス、ID、ラベル、ファイルパス）

タスク生成のコンテキスト: $ARGUMENTS

tasks.md はすぐに実行可能である必要があります - 各タスクは、LLMが追加のコンテキストなしで完了できるほど具体的でなければなりません。

## タスク生成ルール

**重要**: タスクは独立した実装とテストを可能にするため、ユーザーストーリーごとに整理する**必要があります**。

**テストはオプションです**: 機能仕様で明示的に要求された場合、またはユーザーがTDDアプローチを要求した場合にのみ、テストタスクを生成します。

### チェックリスト形式（必須）

すべてのタスクはこの形式に厳密に従う**必要があります**:

```text
- [ ] [TaskID] [P?] [Story?] Description with file path
```

**形式コンポーネント**:

1. **チェックボックス**: 常に `- [ ]`（マークダウンチェックボックス）で開始
2. **タスクID**: 実行順序の連番（T001、T002、T003...）
3. **[P] マーカー**: タスクが並列化可能な場合のみ含める（異なるファイル、未完了タスクへの依存なし）
4. **[Story] ラベル**: ユーザーストーリーフェーズタスクのみ必須
   - 形式: [US1]、[US2]、[US3]など（spec.md のユーザーストーリーにマッピング）
   - セットアップフェーズ: ストーリーラベルなし
   - 基礎フェーズ: ストーリーラベルなし
   - ユーザーストーリーフェーズ: ストーリーラベル必須
   - 洗練フェーズ: ストーリーラベルなし
5. **説明**: 正確なファイルパスを含む明確なアクション

**例**:

- ✅ 正しい: `- [ ] T001 Create project structure per implementation plan`
- ✅ 正しい: `- [ ] T005 [P] Implement authentication middleware in src/middleware/auth.py`
- ✅ 正しい: `- [ ] T012 [P] [US1] Create User model in src/models/user.py`
- ✅ 正しい: `- [ ] T014 [US1] Implement UserService in src/services/user_service.py`
- ❌ 誤り: `- [ ] Create User model`（IDとストーリーラベルがない）
- ❌ 誤り: `T001 [US1] Create model`（チェックボックスがない）
- ❌ 誤り: `- [ ] [US1] Create User model`（タスクIDがない）
- ❌ 誤り: `- [ ] T001 [US1] Create model`（ファイルパスがない）

### タスク構成

1. **ユーザーストーリーから（spec.md）** - 主要な構成:
   - 各ユーザーストーリー（P1、P2、P3...）は独自のフェーズを持つ
   - 関連するすべてのコンポーネントをストーリーにマッピング:
     - そのストーリーに必要なモデル
     - そのストーリーに必要なサービス
     - そのストーリーに必要なエンドポイント/UI
     - テストが要求された場合: そのストーリー固有のテスト
   - ストーリーの依存関係をマーク（ほとんどのストーリーは独立している必要があります）

2. **契約から**:
   - 各契約/エンドポイント → それがサービスを提供するユーザーストーリーにマッピング
   - テストが要求された場合: 各契約 → そのストーリーのフェーズでの実装前に契約テストタスク [P]

3. **データモデルから**:
   - 各エンティティをそれを必要とするユーザーストーリーにマッピング
   - エンティティが複数のストーリーにサービスを提供する場合: 最も早いストーリーまたはセットアップフェーズに配置
   - リレーションシップ → 適切なストーリーフェーズのサービスレイヤータスク

4. **セットアップ/インフラストラクチャから**:
   - 共有インフラストラクチャ → セットアップフェーズ（フェーズ1）
   - 基礎/ブロッキングタスク → 基礎フェーズ（フェーズ2）
   - ストーリー固有のセットアップ → そのストーリーのフェーズ内

### フェーズ構造

- **フェーズ1**: セットアップ（プロジェクト初期化）
- **フェーズ2**: 基礎（ブロッキング前提条件 - ユーザーストーリーの前に完了する必要があります）
- **フェーズ3以降**: 優先順位順のユーザーストーリー（P1、P2、P3...）
  - 各ストーリー内: テスト（要求された場合） → モデル → サービス → エンドポイント → 統合
  - 各フェーズは完全で独立してテスト可能なインクリメントである必要があります
- **最終フェーズ**: 洗練と横断的関心事
