---
description: タスク生成後に spec.md、plan.md、tasks.md の非破壊的なクロスアーティファクトの一貫性と品質分析を実行します。
---

## ユーザー入力

```text
$ARGUMENTS
```

続行する前に、ユーザー入力を**必ず**考慮してください（空でない場合）。

## 目標

実装前に、3つの中核アーティファクト（`spec.md`、`plan.md`、`tasks.md`）全体の不整合、重複、曖昧さ、および不明確な項目を特定します。このコマンドは、`/speckit.tasks` が完全な `tasks.md` を正常に生成した後にのみ実行する必要があります。

## 動作制約

**厳密な読み取り専用**: ファイルを**一切変更しない**でください。構造化された分析レポートを出力します。オプションの修復計画を提供します（ユーザーは、フォローアップの編集コマンドを手動で呼び出す前に明示的に承認する必要があります）。

**憲章の権限**: プロジェクト憲章（`.specify/memory/constitution.md`）は、この分析スコープ内で**交渉の余地がありません**。憲章の競合は自動的に CRITICAL となり、spec、plan、または tasks の調整が必要です。原則の希釈、再解釈、または黙認は許可されません。原則自体を変更する必要がある場合は、`/speckit.analyze` の外部で別の明示的な憲章更新として行う必要があります。

## 実行ステップ

### 1. 分析コンテキストの初期化

リポジトリルートから `.specify/scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks` を一度実行し、JSON を解析して FEATURE_DIR と AVAILABLE_DOCS を取得します。絶対パスを導出します:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

必要なファイルが見つからない場合はエラーメッセージで中止します（不足している前提条件コマンドを実行するようユーザーに指示します）。
"I'm Groot" のような引数内の単一引用符には、エスケープ構文を使用してください: 例 'I'\''m Groot'（可能であれば二重引用符を使用: "I'm Groot"）。

### 2. アーティファクトの読み込み（段階的開示）

各アーティファクトから必要最小限のコンテキストのみを読み込みます:

**spec.md から:**

- 概要/コンテキスト
- 機能要件
- 非機能要件
- ユーザーストーリー
- エッジケース（存在する場合）

**plan.md から:**

- アーキテクチャ/スタックの選択
- データモデルの参照
- フェーズ
- 技術的制約

**tasks.md から:**

- タスク ID
- 説明
- フェーズのグループ化
- 並列マーカー [P]
- 参照されるファイルパス

**憲章から:**

- 原則検証のために `.specify/memory/constitution.md` を読み込み

### 3. セマンティックモデルの構築

内部表現を作成します（生のアーティファクトを出力に含めないでください）:

- **要件インベントリ**: 各機能要件と非機能要件に安定したキーを付与（命令形フレーズに基づいてスラッグを導出。例: "User can upload file" → `user-can-upload-file`）
- **ユーザーストーリー/アクションインベントリ**: 受け入れ基準を含む個別のユーザーアクション
- **タスクカバレッジマッピング**: 各タスクを1つ以上の要件またはストーリーにマッピング（キーワード/ID やキーフレーズなどの明示的な参照パターンによる推論）
- **憲章ルールセット**: 原則名と MUST/SHOULD 規範的ステートメントを抽出

### 4. 検出パス（トークン効率的な分析）

高シグナルの発見に焦点を当てます。発見を合計50件に制限し、残りはオーバーフロー要約に集約します。

#### A. 重複検出

- ほぼ重複している要件を特定
- 統合のために品質の低い表現をマーク

#### B. 曖昧さ検出

- 測定可能な基準が欠けている曖昧な形容詞（高速、スケーラブル、安全、直感的、堅牢）にフラグを立てる
- 未解決のプレースホルダー（TODO、TKTK、???、`<placeholder>` など）にフラグを立てる

#### C. 不明確な仕様

- 動詞はあるが対象または測定可能な結果が欠けている要件
- 受け入れ基準の整合性が欠けているユーザーストーリー
- spec/plan で定義されていないファイルやコンポーネントを参照しているタスク

#### D. 憲章との整合性

- MUST 原則と競合する要件またはプラン要素
- 憲章から義務付けられたセクションまたは品質ゲートの欠落

#### E. カバレッジギャップ

- 関連するタスクが0の要件
- マッピングされた要件/ストーリーがないタスク
- タスクに反映されていない非機能要件（例: パフォーマンス、セキュリティ）

#### F. 不整合

- 用語の揺れ（ファイル間で同じ概念が異なる名前で呼ばれている）
- plan で参照されているが spec にはないデータエンティティ（またはその逆）
- タスク順序の矛盾（例: 依存関係の記述なしに、基盤セットアップタスクの前に統合タスクがある）
- 競合する要件（例: 一方は Next.js を要求し、他方は Vue を指定）

### 5. 重要度の割り当て

発見の優先順位付けにこのヒューリスティックを使用します:

- **CRITICAL**: 憲章の MUST に違反、コア仕様アーティファクトの欠落、またはベースライン機能をブロックするカバレッジ0の要件
- **HIGH**: 重複または競合する要件、曖昧なセキュリティ/パフォーマンス属性、テスト不可能な受け入れ基準
- **MEDIUM**: 用語の揺れ、非機能タスクカバレッジの欠落、不明確なエッジケース
- **LOW**: スタイル/文言の改善、実行順序に影響しない軽微な冗長性

### 6. コンパクトな分析レポートの生成

次の構造を持つ Markdown レポートを出力します（ファイル書き込みなし）:

## 仕様分析レポート

| ID | カテゴリ | 重要度 | 場所 | 概要 | 推奨事項 |
|----|----------|----------|-------------|---------|----------------|
| A1 | Duplication | HIGH | spec.md:L120-134 | Two similar requirements ... | Merge phrasing; keep clearer version |

（発見ごとに1行追加。カテゴリの頭文字を接頭辞として安定した ID を生成します。）

**カバレッジ要約表:**

| 要件キー | タスクあり? | タスク ID | 備考 |
|-----------------|-----------|----------|-------|

**憲章整合性の問題:** （ある場合）

**マッピングされていないタスク:** （ある場合）

**メトリクス:**

- 総要件数
- 総タスク数
- カバレッジ %（1つ以上のタスクを持つ要件）
- 曖昧さカウント
- 重複カウント
- クリティカル問題カウント

### 7. 次のアクションの提供

レポートの最後に、簡潔な「次のアクション」ブロックを出力します:

- CRITICAL 問題が存在する場合: `/speckit.implement` の前に解決することを推奨
- LOW/MEDIUM のみの場合: ユーザーは続行できますが、改善提案を提供
- 明示的なコマンド提案を提供: 例: "Run /speckit.specify with refinement"、"Run /speckit.plan to adjust architecture"、"Manually edit tasks.md to add coverage for 'performance-metrics'"

### 8. 修復の提供

ユーザーに尋ねます: "上位 N 件の問題に対する具体的な修復編集を提案しましょうか？"（自動的には適用しないでください。）

## 動作原則

### コンテキスト効率

- **最小限の高シグナルトークン**: 包括的なドキュメントではなく、実行可能な発見に焦点を当てる
- **段階的開示**: アーティファクトを段階的に読み込む。すべてのコンテンツを分析にダンプしない
- **トークン効率的な出力**: 発見表を50行に制限。オーバーフローを要約
- **決定論的な結果**: 変更なしで再実行すると、一貫した ID とカウントが生成される

### 分析ガイドライン

- **ファイルを絶対に変更しない**（これは読み取り専用分析です）
- **欠落しているセクションを捏造しない**（存在しない場合は正確に報告する）
- **憲章違反を優先する**（これらは常に CRITICAL です）
- **包括的なルールよりも例を使用する**（一般的なパターンではなく、具体的な事例を引用）
- **問題ゼロを適切に報告する**（カバレッジ統計を含む成功レポートを出力）

## コンテキスト

$ARGUMENTS
